// filename: backend/prisma/schema.prisma
// Version: 1.1.0 (Add adminNotes field to User model)

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS ---

enum UserRole {
  SUPER_ADMIN
  BUSINESS_ADMIN
  CUSTOMER_FINAL
}

enum DocumentType {
  DNI
  NIE
  PASSPORT
  OTHER
}

enum QrCodeStatus {
  PENDING
  COMPLETED
  EXPIRED
}

// Tier System Enums
enum TierCalculationBasis {
  SPEND
  VISITS
  POINTS_EARNED
}

enum TierDowngradePolicy {
  NEVER
  PERIODIC_REVIEW
  AFTER_INACTIVITY
}

enum BenefitType {
  POINTS_MULTIPLIER
  EXCLUSIVE_REWARD_ACCESS
  CUSTOM_BENEFIT
}


// --- MODELS ---

model Business {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  pointsPerEuro Float     @default(1.0)
  currency    String    @default("EUR")
  brandingColor String?
  subscriptionStatus String @default("trial")
  trialEndsAt   DateTime?
  lastPaymentDate DateTime?

  // Relationships
  users       User[]
  rewards     Reward[]
  qrCodes     QrCode[]

  // Tier System Fields
  tierSystemEnabled         Boolean?             @default(false)
  tierCalculationBasis      TierCalculationBasis?
  tierCalculationPeriodMonths Int?
  tierDowngradePolicy       TierDowngradePolicy? @default(NEVER)
  inactivityPeriodMonths    Int?
  tiers                     Tier[]
  grantedRewards          GrantedReward[]

  @@map("businesses")
}

model User {
  id                    String      @id @default(uuid())
  email                 String      @unique
  password              String
  name                  String?
  phone                 String?     @unique
  role                  UserRole
  isActive              Boolean     @default(true)
  isFavorite            Boolean     @default(false)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  businessId            String
  points                Int         @default(0)
  marketingOptIn        Boolean     @default(false)
  documentId            String?     @unique
  documentType          DocumentType?
  resetPasswordToken    String?     @unique
  resetPasswordExpires  DateTime?

  // Tier System Fields
  currentTierId       String?
  tierAchievedAt      DateTime?
  lastActivityAt      DateTime?
  totalSpend          Float?      @default(0)
  totalVisits         Int?        @default(0)
  totalPointsEarned   Int?        @default(0)

  // --- NUEVO CAMPO AÑADIDO ---
  adminNotes            String?     // Campo opcional para notas del admin
  // -------------------------

  // --- LÍNEAS DE RELACIÓN INVERSA AÑADIDAS ---
  grantedRewards        GrantedReward[] @relation("UserGrantedRewards")
  assignedGrantedRewards GrantedReward[] @relation("AdminGrantedRewards")
  // ------------------------------------------

  // --- Relaciones existentes ---
  business    Business @relation(fields: [businessId], references: [id])
  qrCodes     QrCode[]
  currentTier Tier?    @relation(fields: [currentTierId], references: [id], onDelete: SetNull)

  @@map("users")
}

model Reward {
  id          String    @id @default(uuid())
  businessId  String
  name        String
  description String?
  pointsCost  Int
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  business    Business @relation(fields: [businessId], references: [id])
  grantedInstances GrantedReward[]

  @@map("rewards")
}

model QrCode {
  id            String       @id @default(uuid())
  token         String       @unique
  businessId    String
  amount        Float
  ticketNumber  String
  status        QrCodeStatus @default(PENDING)
  createdAt     DateTime     @default(now())
  expiresAt     DateTime
  completedAt   DateTime?
  userId        String?
  pointsEarned  Int?

  // Relationships
  business    Business @relation(fields: [businessId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])

  @@map("qr_codes")
}


// --- TIER SYSTEM MODELS (sin cambios) ---

model Tier {
  id                  String    @id @default(uuid())
  businessId          String
  name                String
  level               Int
  minValue            Float // <-- OJO: Este campo sí existe en tu modelo Tier
  description         String?
  benefitsDescription String?
  isActive            Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relationships
  business Business @relation(fields: [businessId], references: [id])
  users    User[]
  benefits TierBenefit[]

  @@unique([businessId, level])
  @@unique([businessId, name])
}

model TierBenefit {
  id          String      @id @default(uuid())
  tierId      String
  type        BenefitType
  value       String
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relationships
  tier Tier @relation(fields: [tierId], references: [id], onDelete: Cascade)
}


// --- NUEVO MODELO AÑADIDO ---
model GrantedReward {
  id           String   @id @default(uuid())
  userId       String
  rewardId     String
  businessId   String
  assignedById String
  assignedAt   DateTime @default(now())
  status       String   @default("PENDING")
  redeemedAt   DateTime?

  // Relaciones
  user         User     @relation("UserGrantedRewards", fields: [userId], references: [id], onDelete: Cascade)
  reward       Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  business     Business @relation(fields: [businessId], references: [id])
  assignedBy   User     @relation("AdminGrantedRewards", fields: [assignedById], references: [id])

  @@map("granted_rewards")
}
// --- FIN NUEVO MODELO ---

// --- FIN DEL CÓDIGO COMPLETO ---